<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2563eb">
<title>Ø¹Ø¯Ø§Ø¯ Ù†Ù‚Ø§Ø· ØªØ±ÙƒØ³ â€” PWA v4</title>
<style>
  :root { --gap: 12px; --pad: 12px; }
  * { box-sizing: border-box; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", "Noto Sans Arabic", Arial, sans-serif; }
  body { margin: 0; background: #f7f7f9; color: #222; }
  header { position: sticky; top: 0; background: #ffffffd9; backdrop-filter: blur(6px); border-bottom: 1px solid #e5e7eb; padding: 10px var(--pad); z-index: 50; }
  h1 { font-size: 18px; margin: 0; }
  main { padding: var(--pad); display: grid; gap: var(--gap); max-width: 980px; margin: 0 auto; }
  .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: var(--pad); box-shadow: 0 1px 2px rgba(0,0,0,.03); }
  .row { display: grid; gap: var(--gap); }
  .grid-2 { grid-template-columns: 1fr 1fr; }
  .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
  .grid-4 { grid-template-columns: repeat(4, 1fr); }
  label { font-size: 13px; color: #444; }
  input[type="text"], input[type="number"], select, button, textarea {
    width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #d1d5db; background: #fff; font-size: 14px;
  }
  button { cursor: pointer; }
  button.primary { background: #2563eb; color: #fff; border-color: #1d4ed8; }
  button.ghost { background: #f3f4f6; }
  .buttons { display: flex; gap: 8px; flex-wrap: wrap; }
  table { width: 100%; border-collapse: collapse; border-radius: 10px; overflow: hidden; }
  th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
  thead th { background: #f3f4f6; font-weight: 600; }
  tfoot td { background: #fafafa; font-weight: 700; }
  .totals { font-weight: 700; }
  .muted { color: #6b7280; font-size: 12px; }
  .tag { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef2ff; color: #3730a3; font-size: 12px; }
  .nowrap { white-space: nowrap; }
  .hr { height: 1px; background: #eee; margin: 10px 0; }
  .small { font-size: 12px; }
  .scroll-x { overflow-x: auto; }
  .toast { position: fixed; inset-inline-start: 50%; transform: translateX(-50%); bottom: 16px;
           background: #111827; color: #fff; padding: 10px 14px; border-radius: 999px; font-size: 13px; display:none; z-index: 100; }
  .highlight { animation: hl 1.4s ease; }
  @keyframes hl { 0% { background:#fff59d; } 100% { background:transparent; } }
</style>
</head>
<body>
  <header>
    <h1>ğŸ“Š Ø¹Ø¯Ù‘Ø§Ø¯ Ù†Ù‚Ø§Ø· ØªØ±ÙƒØ³ â€” PWA v4</h1>
    <div class="muted small">Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ø±Ø© + ØªØ¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ† â€¢ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ø®ØªÙØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ù„Ø¨Ù†Ø§Øª â€¢ Ù„Ø§ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù‚ÙˆØ§Ø¦Ù…</div>
  </header>

  <main>
    <section class="card">
      <div class="row grid-4">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ 1</label>
          <input id="p0" type="text" placeholder="Ù„Ø§Ø¹Ø¨ 1" />
        </div>
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ 2</label>
          <input id="p1" type="text" placeholder="Ù„Ø§Ø¹Ø¨ 2" />
        </div>
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ 3</label>
          <input id="p2" type="text" placeholder="Ù„Ø§Ø¹Ø¨ 3" />
        </div>
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ 4</label>
          <input id="p3" type="text" placeholder="Ù„Ø§Ø¹Ø¨ 4" />
        </div>
      </div>
      <div class="hr"></div>
      <div class="buttons">
        <button class="primary" id="saveNamesBtn">Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
        <button class="ghost" id="refreshListsBtn">ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</button>
        <button class="ghost" id="resetAllBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ÙƒÙ„</button>
        <button class="ghost" id="undoBtn">ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± Ø¬ÙˆÙ„Ø©</button>
        <button class="ghost" id="exportBtn">ØªØµØ¯ÙŠØ± (JSON)</button>
        <label for="importFile" class="ghost" style="padding:10px 14px;border:1px solid #d1d5db;border-radius:10px;cursor:pointer;">Ø§Ø³ØªÙŠØ±Ø§Ø¯ (JSON)</label>
        <input id="importFile" type="file" accept="application/json" style="display:none;" />
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0;">â• Ø¥Ø¶Ø§ÙØ© Ø¬ÙˆÙ„Ø© (Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ)</h3>
      <div class="row grid-2">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ø¬ÙˆÙ„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="roundLabel" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ù†Ø§Øª / Ù…Ù„Ùƒ Ù‚Ù„ÙˆØ¨ / ØªØ±ÙƒØ³..." />
        </div>
        <div>
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="roundNote" type="text" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©" />
        </div>
      </div>
      <div class="row grid-4" style="margin-top:var(--gap);">
        <div>
          <label>Ù†Ù‚Ø§Ø· Ù„Ø§Ø¹Ø¨ 1</label>
          <input id="s0" type="number" inputmode="numeric" placeholder="0" />
        </div>
        <div>
          <label>Ù†Ù‚Ø§Ø· Ù„Ø§Ø¹Ø¨ 2</label>
          <input id="s1" type="number" inputmode="numeric" placeholder="0" />
        </div>
        <div>
          <label>Ù†Ù‚Ø§Ø· Ù„Ø§Ø¹Ø¨ 3</label>
          <input id="s2" type="number" inputmode="numeric" placeholder="0" />
        </div>
        <div>
          <label>Ù†Ù‚Ø§Ø· Ù„Ø§Ø¹Ø¨ 4</label>
          <input id="s3" type="number" inputmode="numeric" placeholder="0" />
        </div>
      </div>
      <div class="buttons" style="margin-top:var(--gap);">
        <button class="primary" id="addRoundBtn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0;">ğŸ§® Ù…ÙØ¹ÙŠÙ† Ø§Ù„ÙƒØ¨Ø§Øª (ØªÙØµÙŠÙ„ÙŠ)</h3>

      <div class="card" style="border-style:dashed; margin-bottom:12px;">
        <div class="wrap">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <span class="tag">Ø§Ù„Ø¨Ù†Ø§Øª â€” ØªØ­Ø¯ÙŠØ¯ Ù„ÙƒÙ„ Ø¨Ù†Øª</span>
            <span class="muted small">ÙƒÙ„ Ø¨Ù†Øª âˆ’25 | Ø¥Ø°Ø§ Ø¯Ø¨Ù„Øª âˆ’50 | Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ù…ÙØ¬Ø¨ÙØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø¨Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
          </div>

          <div class="row grid-4">
            <div>
              <label>Ø¨Ù†Øª â™¦ (Ø§Ù„Ø¯ÙŠÙ…Ù†) â€” Ù…Ù† Ø£ÙƒÙ„Ù‡Ø§ØŸ</label>
              <select id="qD_taker"></select>
              <label class="small">Ø¯Ø¨Ù„ØŸ</label>
              <select id="qD_dbl"><option value="no">Ù„Ø§</option><option value="yes">Ù†Ø¹Ù…</option></select>
              <label class="small">Ù…Ù† Ø£Ø¬Ø¨Ø±Ù‡ØŸ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <select id="qD_forcer"></select>
            </div>
            <div>
              <label>Ø¨Ù†Øª â™¥ â€” Ù…Ù† Ø£ÙƒÙ„Ù‡Ø§ØŸ</label>
              <select id="qH_taker"></select>
              <label class="small">Ø¯Ø¨Ù„ØŸ</label>
              <select id="qH_dbl"><option value="no">Ù„Ø§</option><option value="yes">Ù†Ø¹Ù…</option></select>
              <label class="small">Ù…Ù† Ø£Ø¬Ø¨Ø±Ù‡ØŸ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <select id="qH_forcer"></select>
            </div>
            <div>
              <label>Ø¨Ù†Øª â™  â€” Ù…Ù† Ø£ÙƒÙ„Ù‡Ø§ØŸ</label>
              <select id="qS_taker"></select>
              <label class="small">Ø¯Ø¨Ù„ØŸ</label>
              <select id="qS_dbl"><option value="no">Ù„Ø§</option><option value="yes">Ù†Ø¹Ù…</option></select>
              <label class="small">Ù…Ù† Ø£Ø¬Ø¨Ø±Ù‡ØŸ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <select id="qS_forcer"></select>
            </div>
            <div>
              <label>Ø¨Ù†Øª â™£ â€” Ù…Ù† Ø£ÙƒÙ„Ù‡Ø§ØŸ</label>
              <select id="qC_taker"></select>
              <label class="small">Ø¯Ø¨Ù„ØŸ</label>
              <select id="qC_dbl"><option value="no">Ù„Ø§</option><option value="yes">Ù†Ø¹Ù…</option></select>
              <label class="small">Ù…Ù† Ø£Ø¬Ø¨Ø±Ù‡ØŸ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <select id="qC_forcer"></select>
            </div>
          </div>

          <div class="row grid-3">
            <div>
              <label>Ù‚ÙŠÙ…Ø© Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ù…ÙØ¬Ø¨ÙØ± (Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø¨Ù„ ÙÙ‚Ø·)</label>
              <input id="qBonus" type="number" inputmode="numeric" value="25" />
            </div>
            <div class="buttons" style="align-items:end;">
              <button id="applyQueensDetailed" class="primary">Ø¥Ø¶Ø§ÙØ© Ø¬ÙˆÙ„Ø© Ø§Ù„Ø¨Ù†Ø§Øª (ØªÙØµÙŠÙ„ÙŠ)</button>
            </div>
          </div>
        </div>
      </div>

      <div class="row grid-2">
        <div class="card" style="border-style:dashed;">
          <div class="wrap">
            <div><span class="tag">Ø´Ø§ÙŠØ¨ Ø§Ù„Ù‚Ù„ÙˆØ¨ (King â™¥)</span> <span class="muted small">âˆ’75 | Ø§Ù„Ø¯Ø¨Ù„ âˆ’150 | Ù…ÙƒØ§ÙØ£Ø© Ù…ÙØ¬Ø¨ÙØ± Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø¨Ù„</span></div>
            <div class="row grid-3">
              <div>
                <label>Ù…Ù† Ø£ÙƒÙ„ Ø§Ù„Ù…Ù„ÙƒØŸ</label>
                <select id="khWho"></select>
              </div>
              <div>
                <label class="nowrap">Ø¯Ø¨Ù„ØŸ</label>
                <select id="khDbl">
                  <option value="no">Ù„Ø§</option>
                  <option value="yes">Ù†Ø¹Ù…</option>
                </select>
              </div>
              <div>
                <label>Ù…Ù† Ø£Ø¬Ø¨Ø±Ù‡ØŸ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <select id="khForcer"></select>
              </div>
            </div>
            <div class="row grid-3">
              <div>
                <label>Ù‚ÙŠÙ…Ø© Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ù…ÙØ¬Ø¨ÙØ± (Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø¨Ù„ ÙÙ‚Ø·)</label>
                <input id="khBonus" type="number" inputmode="numeric" value="25" />
              </div>
              <div class="buttons" style="align-items:end;">
                <button id="applyKing" class="primary">Ø¥Ø¶Ø§ÙØ© Ø¬ÙˆÙ„Ø© Ù…Ù„Ùƒ Ø§Ù„Ù‚Ù„ÙˆØ¨</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="border-style:dashed;">
          <div class="wrap">
            <div><span class="tag">Ù„Ø·ÙˆØ´ (Ø¢Ø®Ø± Ù„ÙØ·Ù’Ø´Ø©)</span> <span class="muted small">Ù…Ù† ÙŠØ£Ø®Ø° Ø¢Ø®Ø± Ù„Ø·Ø´Ø© âˆ’25 â€¢ Ø§Ù„Ø¯Ø¨Ù„ âˆ’50</span></div>
            <div class="row grid-3">
              <div>
                <label>Ù…Ù† Ø£Ø®Ø° Ø¢Ø®Ø± Ù„Ø·Ø´Ø©ØŸ</label>
                <select id="ltWho"></select>
              </div>
              <div>
                <label class="nowrap">Ø¯Ø¨Ù„ØŸ</label>
                <select id="ltDbl">
                  <option value="no">Ù„Ø§</option>
                  <option value="yes">Ù†Ø¹Ù…</option>
                </select>
              </div>
            </div>
            <div class="buttons">
              <button id="applyLotoush" class="primary">Ø¥Ø¶Ø§ÙØ© Ø¬ÙˆÙ„Ø© Ø§Ù„Ù„Ø·ÙˆØ´</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="border-style:dashed; margin-top:12px;">
        <div class="wrap">
          <div><span class="tag">Ø¯ÙŠÙ†Ø§Ø±ÙŠ (â™¦)</span> <span class="muted small">Ù„ÙƒÙ„ Ø¯ÙŠÙ†Ø§Ø±ÙŠ âˆ’5 â€¢ Ù…Ø¹ Ø§Ù„Ø¯Ø¨Ù„ âˆ’10</span></div>
          <div class="row grid-4">
            <div><label>Ø¯ÙŠÙ†Ø§Ø±ÙŠ Ù„Ø§Ø¹Ø¨ 1</label><input id="d0" type="number" min="0" value="0"></div>
            <div><label>Ù„Ø§Ø¹Ø¨ 2</label><input id="d1" type="number" min="0" value="0"></div>
            <div><label>Ù„Ø§Ø¹Ø¨ 3</label><input id="d2" type="number" min="0" value="0"></div>
            <div><label>Ù„Ø§Ø¹Ø¨ 4</label><input id="d3" type="number" min="0" value="0"></div>
          </div>
          <div class="buttons">
            <label><input id="ddbl" type="checkbox"> Ø¯Ø¨Ù„</label>
            <button id="applyDenari" class="primary">Ø¥Ø¶Ø§ÙØ© Ø¬ÙˆÙ„Ø© Ø§Ù„Ø¯ÙŠÙ†Ø§Ø±ÙŠ</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0;">ğŸ“’ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª</h3>
      <div class="scroll-x">
        <table id="roundsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„Ø¬ÙˆÙ„Ø©</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
              <th class="nowrap" id="h0">Ù„Ø§Ø¹Ø¨ 1</th>
              <th class="nowrap" id="h1">Ù„Ø§Ø¹Ø¨ 2</th>
              <th class="nowrap" id="h2">Ù„Ø§Ø¹Ø¨ 3</th>
              <th class="nowrap" id="h3">Ù„Ø§Ø¹Ø¨ 4</th>
              <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            </tr>
          </thead>
          <tbody id="roundsBody"></tbody>
          <tfoot>
            <tr class="totals">
              <td colspan="3">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
              <td id="t0">0</td>
              <td id="t1">0</td>
              <td id="t2">0</td>
              <td id="t3">0</td>
              <td id="tAll">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </main>

  <div id="toast" class="toast">ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬ÙˆÙ„Ø© âœ…</div>

<script>
// Register SW
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js');
  });
}

(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const state = {
    players: ["Ù„Ø§Ø¹Ø¨ 1","Ù„Ø§Ø¹Ø¨ 2","Ù„Ø§Ø¹Ø¨ 3","Ù„Ø§Ø¹Ø¨ 4"],
    rounds: []
  };

  const KEYS = {
    players: "trix_pwa_v4_players",
    rounds: "trix_pwa_v4_rounds"
  };

  function saveLS(){
    try {
      localStorage.setItem(KEYS.players, JSON.stringify(state.players));
      localStorage.setItem(KEYS.rounds, JSON.stringify(state.rounds));
    } catch(e){}
  }
  function loadLS(){
    try {
      const p = JSON.parse(localStorage.getItem(KEYS.players));
      const r = JSON.parse(localStorage.getItem(KEYS.rounds));
      if (Array.isArray(p) && p.length === 4) state.players = p;
      if (Array.isArray(r)) state.rounds = r;
    } catch(e){}
  }

  function showToast(msg="ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬ÙˆÙ„Ø© âœ…"){
    const t = $("#toast");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(()=>{ t.style.display="none"; }, 1600);
  }

  function setSelectOptions(el, names, preserve=true){
    if (!el) return;
    const prev = preserve ? el.value : "";
    while (el.options.length) el.remove(0);
    el.add(new Option("â€”",""));
    names.forEach((n,idx)=> el.add(new Option(n, String(idx))));
    if (preserve && prev !== "" && Number(prev) >= 0) el.value = prev;
  }

  function refreshAllPlayerSelects(preserve=true){
    const names = state.players.map((n,i)=> n || ("Ù„Ø§Ø¹Ø¨ "+(i+1)));
    ["qD_taker","qH_taker","qS_taker","qC_taker",
     "qD_forcer","qH_forcer","qS_forcer","qC_forcer",
     "khWho","khForcer","ltWho"].forEach(id=>{
      setSelectOptions($("#"+id), names, preserve);
    });
  }

  function renderPlayers(){
    for (let i=0;i<4;i++){
      $("#p"+i).value = state.players[i] || ("Ù„Ø§Ø¹Ø¨ "+(i+1));
      $("#h"+i).textContent = state.players[i] || ("Ù„Ø§Ø¹Ø¨ "+(i+1));
    }
    refreshAllPlayerSelects(true); // preserve current selections
  }

  function totals(){
    const t = [0,0,0,0];
    let all = 0;
    for (const r of state.rounds){
      for (let i=0;i<4;i++){ t[i] += (Number(r.scores[i])||0); }
      all += r.scores.reduce((a,b)=>a+(Number(b)||0),0);
    }
    for (let i=0;i<4;i++){ $("#t"+i).textContent = t[i]; }
    $("#tAll").textContent = all;
  }

  function renderRounds(){
    const body = $("#roundsBody");
    body.innerHTML = "";
    state.rounds.forEach((r,idx)=>{
      const tr = document.createElement("tr");
      const sum = r.scores.reduce((a,b)=>a+(Number(b)||0),0);
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${r.label || "-"}</td>
        <td>${r.note || "-"}</td>
        <td>${r.scores[0]}</td>
        <td>${r.scores[1]}</td>
        <td>${r.scores[2]}</td>
        <td>${r.scores[3]}</td>
        <td>${sum}</td>
      `;
      tr.classList.add("highlight");
      body.appendChild(tr);
    });
    totals();
    saveLS();
    const container = body.parentElement;
    container.scrollTop = container.scrollHeight;
  }

  function addRound(label, note, scores){
    try{
      const nums = scores.map(v => Number(v)||0);
      state.rounds.push({label, note, scores: nums});
      renderRounds();
      showToast();
    } catch(e){
      alert("ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬ÙˆÙ„Ø©. Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.");
    }
  }

  function init(){
    loadLS();
    renderPlayers();
    renderRounds();

    $("#saveNamesBtn").addEventListener("click", ()=>{
      for (let i=0;i<4;i++){
        state.players[i] = $("#p"+i).value.trim() || ("Ù„Ø§Ø¹Ø¨ "+(i+1));
      }
      renderPlayers(); // refresh with preserve
      saveLS();
      showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ âœ…");
    });

    $("#refreshListsBtn").addEventListener("click", ()=>{
      refreshAllPlayerSelects(true);
      showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ğŸ”");
    });

    $("#resetAllBtn").addEventListener("click", ()=>{
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„ Ø´ÙŠØ¡ØŸ Ø³ØªÙØ­Ø°Ù Ø§Ù„Ø¬ÙˆÙ„Ø§Øª ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡.")) return;
      state.players = ["Ù„Ø§Ø¹Ø¨ 1","Ù„Ø§Ø¹Ø¨ 2","Ù„Ø§Ø¹Ø¨ 3","Ù„Ø§Ø¹Ø¨ 4"];
      state.rounds = [];
      renderPlayers();
      renderRounds();
      showToast("ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· â™»ï¸");
    });

    $("#undoBtn").addEventListener("click", ()=>{
      if (state.rounds.length === 0) return;
      state.rounds.pop();
      renderRounds();
      showToast("ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ â†©ï¸");
    });

    $("#addRoundBtn").addEventListener("click", ()=>{
      const label = $("#roundLabel").value.trim();
      const note = $("#roundNote").value.trim();
      const s0 = $("#s0").value, s1=$("#s1").value, s2=$("#s2").value, s3=$("#s3").value;
      addRound(label || "Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ", note, [s0,s1,s2,s3]);
      ["#roundLabel","#roundNote","#s0","#s1","#s2","#s3"].forEach(id=>$(id).value="");
    });

    // Queens detailed
    $("#applyQueensDetailed").addEventListener("click", ()=>{
      const scores = [0,0,0,0];
      const bonus = Number($("#qBonus").value)||0;

      const queens = [
        { taker: $("#qD_taker").value, dbl: $("#qD_dbl").value==="yes", forcer: $("#qD_forcer").value, name:"Qâ™¦" },
        { taker: $("#qH_taker").value, dbl: $("#qH_dbl").value==="yes", forcer: $("#qH_forcer").value, name:"Qâ™¥" },
        { taker: $("#qS_taker").value, dbl: $("#qS_dbl").value==="yes", forcer: $("#qS_forcer").value, name:"Qâ™ " },
        { taker: $("#qC_taker").value, dbl: $("#qC_dbl").value==="yes", forcer: $("#qC_forcer").value, name:"Qâ™£" },
      ];

      let noteParts = [];
      queens.forEach(q => {
        if (q.taker !== "") {
          const penalty = q.dbl ? -50 : -25;
          scores[Number(q.taker)] += penalty;
          noteParts.push(`${q.name}: Ù„Ø§Ø¹Ø¨ ${Number(q.taker)+1}${q.dbl?"(Ø¯Ø¨Ù„)":""}`);
          if (q.dbl && q.forcer !== "") {
            scores[Number(q.forcer)] += bonus;
            noteParts.push(`+${bonus} Ù„Ù„Ù…ÙØ¬Ø¨ÙØ± (Ù„Ø§Ø¹Ø¨ ${Number(q.forcer)+1})`);
          }
        }
      });

      if (noteParts.length === 0) { alert("Ø£Ø¯Ø®Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø¨Ù†Øª ÙˆØ§Ø­Ø¯Ø©."); return; }
      addRound("Ø§Ù„Ø¨Ù†Ø§Øª (ØªÙØµÙŠÙ„ÙŠ)", noteParts.join(" | "), scores);

      // reset fields for next entry
      ["qD_taker","qH_taker","qS_taker","qC_taker",
       "qD_forcer","qH_forcer","qS_forcer","qC_forcer"].forEach(id=>$("#"+id).value="");
      ["qD_dbl","qH_dbl","qS_dbl","qC_dbl"].forEach(id=>$("#"+id).value="no");
    });

    // King of Hearts
    $("#applyKing").addEventListener("click", ()=>{
      const who = $("#khWho").value;
      if (who===""){ alert("Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ Ø£ÙƒÙ„ Ù…Ù„Ùƒ Ø§Ù„Ù‚Ù„ÙˆØ¨."); return; }
      const dbl = $("#khDbl").value === "yes";
      const forcer = $("#khForcer").value;
      const bonus = Number($("#khBonus").value)||0;

      const scores = [0,0,0,0];
      scores[Number(who)] += dbl ? -150 : -75;
      let note = `Ù„Ø§Ø¹Ø¨ ${Number(who)+1}` + (dbl?" (Ø¯Ø¨Ù„)":"");

      if (dbl && forcer !== "") {
        scores[Number(forcer)] += bonus;
        note += ` | +${bonus} Ù„Ù„Ù…ÙØ¬Ø¨ÙØ± (Ù„Ø§Ø¹Ø¨ ${Number(forcer)+1})`;
      }

      addRound("Ù…Ù„Ùƒ Ø§Ù„Ù‚Ù„ÙˆØ¨", note, scores);
      $("#khWho").value=""; $("#khDbl").value="no"; $("#khForcer").value="";
    });

    // Denari
    $("#applyDenari").addEventListener("click", ()=>{
      const d = [$("#d0").value, $("#d1").value, $("#d2").value, $("#d3").value].map(n=>Number(n)||0);
      const dbl = $("#ddbl").checked;
      const per = dbl ? -10 : -5;
      const scores = d.map(cnt => cnt * per);
      addRound("Ø¯ÙŠÙ†Ø§Ø±ÙŠ"+(dbl?" (Ø¯Ø¨Ù„)":""), "", scores);
    });

    // Lotoush
    $("#applyLotoush").addEventListener("click", ()=>{
      const sel = $("#ltWho").value;
      if (sel===""){ alert("Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ Ø£Ø®Ø° Ø¢Ø®Ø± Ù„Ø·Ø´Ø©."); return; }
      const dbl = $("#ltDbl").value === "yes";
      const scores = [0,0,0,0];
      scores[Number(sel)] = dbl ? -50 : -25;
      addRound("Ù„Ø·ÙˆØ´"+(dbl?" (Ø¯Ø¨Ù„)":"") , "", scores);
      $("#ltWho").value=""; $("#ltDbl").value="no";
    });

    // Export / Import
    $("#exportBtn").addEventListener("click", ()=>{
      const data = {
        players: state.players,
        rounds: state.rounds,
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "trix_scores.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    $("#importFile").addEventListener("change", (e)=>{
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(){
        try{
          const data = JSON.parse(reader.result);
          if (Array.isArray(data.players) && Array.isArray(data.rounds)){
            state.players = data.players.slice(0,4);
            state.rounds = data.rounds;
            renderPlayers();
            renderRounds();
            showToast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
          } else {
            alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.");
          }
        } catch(err){
          alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.");
        }
      };
      reader.readAsText(file);
      e.target.value = "";
    });

  } // init

  document.addEventListener("DOMContentLoaded", init);
})();
</script>
</body>
</html>
