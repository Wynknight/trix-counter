<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2563eb">
<title>عداد نقاط تركس — PWA v4</title>
<style>
  :root { --gap: 12px; --pad: 12px; }
  * { box-sizing: border-box; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", "Noto Sans Arabic", Arial, sans-serif; }
  body { margin: 0; background: #f7f7f9; color: #222; }
  header { position: sticky; top: 0; background: #ffffffd9; backdrop-filter: blur(6px); border-bottom: 1px solid #e5e7eb; padding: 10px var(--pad); z-index: 50; }
  h1 { font-size: 18px; margin: 0; }
  main { padding: var(--pad); display: grid; gap: var(--gap); max-width: 980px; margin: 0 auto; }
  .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: var(--pad); box-shadow: 0 1px 2px rgba(0,0,0,.03); }
  .row { display: grid; gap: var(--gap); }
  .grid-2 { grid-template-columns: 1fr 1fr; }
  .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
  .grid-4 { grid-template-columns: repeat(4, 1fr); }
  label { font-size: 13px; color: #444; }
  input[type="text"], input[type="number"], select, button, textarea {
    width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #d1d5db; background: #fff; font-size: 14px;
  }
  button { cursor: pointer; }
  button.primary { background: #2563eb; color: #fff; border-color: #1d4ed8; }
  button.ghost { background: #f3f4f6; }
  .buttons { display: flex; gap: 8px; flex-wrap: wrap; }
  table { width: 100%; border-collapse: collapse; border-radius: 10px; overflow: hidden; }
  th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
  thead th { background: #f3f4f6; font-weight: 600; }
  tfoot td { background: #fafafa; font-weight: 700; }
  .totals { font-weight: 700; }
  .muted { color: #6b7280; font-size: 12px; }
  .tag { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef2ff; color: #3730a3; font-size: 12px; }
  .nowrap { white-space: nowrap; }
  .hr { height: 1px; background: #eee; margin: 10px 0; }
  .small { font-size: 12px; }
  .scroll-x { overflow-x: auto; }
  .toast { position: fixed; inset-inline-start: 50%; transform: translateX(-50%); bottom: 16px;
           background: #111827; color: #fff; padding: 10px 14px; border-radius: 999px; font-size: 13px; display:none; z-index: 100; }
  .highlight { animation: hl 1.4s ease; }
  @keyframes hl { 0% { background:#fff59d; } 100% { background:transparent; } }
</style>
</head>
<body>
  <header>
    <h1>📊 عدّاد نقاط تركس — PWA v4</h1>
    <div class="muted small">نسخة مستقرة + تعمل أوفلاين • إصلاح مشكلة اختفاء اختيار اللاعب للبنات • لا تحديث تلقائي للقوائم</div>
  </header>

  <main>
    <section class="card">
      <div class="row grid-4">
        <div>
          <label>اسم اللاعب 1</label>
          <input id="p0" type="text" placeholder="لاعب 1" />
        </div>
        <div>
          <label>اسم اللاعب 2</label>
          <input id="p1" type="text" placeholder="لاعب 2" />
        </div>
        <div>
          <label>اسم اللاعب 3</label>
          <input id="p2" type="text" placeholder="لاعب 3" />
        </div>
        <div>
          <label>اسم اللاعب 4</label>
          <input id="p3" type="text" placeholder="لاعب 4" />
        </div>
      </div>
      <div class="hr"></div>
      <div class="buttons">
        <button class="primary" id="saveNamesBtn">حفظ الأسماء</button>
        <button class="ghost" id="refreshListsBtn">تحديث قوائم اللاعبين</button>
        <button class="ghost" id="resetAllBtn">إعادة ضبط الكل</button>
        <button class="ghost" id="undoBtn">تراجع عن آخر جولة</button>
        <button class="ghost" id="exportBtn">تصدير (JSON)</button>
        <label for="importFile" class="ghost" style="padding:10px 14px;border:1px solid #d1d5db;border-radius:10px;cursor:pointer;">استيراد (JSON)</label>
        <input id="importFile" type="file" accept="application/json" style="display:none;" />
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0;">➕ إضافة جولة (إدخال يدوي)</h3>
      <div class="row grid-2">
        <div>
          <label>اسم الجولة (اختياري)</label>
          <input id="roundLabel" type="text" placeholder="مثال: بنات / ملك قلوب / تركس..." />
        </div>
        <div>
          <label>ملاحظة (اختياري)</label>
          <input id="roundNote" type="text" placeholder="تفاصيل إضافية" />
        </div>
      </div>
      <div class="row grid-4" style="margin-top:var(--gap);">
        <div>
          <label>نقاط لاعب 1</label>
          <input id="s0" type="number" inputmode="numeric" placeholder="0" />
        </div>
        <div>
          <label>نقاط لاعب 2</label>
          <input id="s1" type="number" inputmode="numeric" placeholder="0" />
        </div>
        <div>
          <label>نقاط لاعب 3</label>
          <input id="s2" type="number" inputmode="numeric" placeholder="0" />
        </div>
        <div>
          <label>نقاط لاعب 4</label>
          <input id="s3" type="number" inputmode="numeric" placeholder="0" />
        </div>
      </div>
      <div class="buttons" style="margin-top:var(--gap);">
        <button class="primary" id="addRoundBtn">إضافة الجولة</button>
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0;">🧮 مُعين الكبات (تفصيلي)</h3>

      <div class="card" style="border-style:dashed; margin-bottom:12px;">
        <div class="wrap">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <span class="tag">البنات — تحديد لكل بنت</span>
            <span class="muted small">كل بنت −25 | إذا دبلت −50 | مكافأة المُجبِر عند الدبل (اختياري)</span>
          </div>

          <div class="row grid-4">
            <div>
              <label>بنت ♦ (الديمن) — من أكلها؟</label>
              <select id="qD_taker"></select>
              <label class="small">دبل؟</label>
              <select id="qD_dbl"><option value="no">لا</option><option value="yes">نعم</option></select>
              <label class="small">من أجبره؟ (اختياري)</label>
              <select id="qD_forcer"></select>
            </div>
            <div>
              <label>بنت ♥ — من أكلها؟</label>
              <select id="qH_taker"></select>
              <label class="small">دبل؟</label>
              <select id="qH_dbl"><option value="no">لا</option><option value="yes">نعم</option></select>
              <label class="small">من أجبره؟ (اختياري)</label>
              <select id="qH_forcer"></select>
            </div>
            <div>
              <label>بنت ♠ — من أكلها؟</label>
              <select id="qS_taker"></select>
              <label class="small">دبل؟</label>
              <select id="qS_dbl"><option value="no">لا</option><option value="yes">نعم</option></select>
              <label class="small">من أجبره؟ (اختياري)</label>
              <select id="qS_forcer"></select>
            </div>
            <div>
              <label>بنت ♣ — من أكلها؟</label>
              <select id="qC_taker"></select>
              <label class="small">دبل؟</label>
              <select id="qC_dbl"><option value="no">لا</option><option value="yes">نعم</option></select>
              <label class="small">من أجبره؟ (اختياري)</label>
              <select id="qC_forcer"></select>
            </div>
          </div>

          <div class="row grid-3">
            <div>
              <label>قيمة مكافأة المُجبِر (عند الدبل فقط)</label>
              <input id="qBonus" type="number" inputmode="numeric" value="25" />
            </div>
            <div class="buttons" style="align-items:end;">
              <button id="applyQueensDetailed" class="primary">إضافة جولة البنات (تفصيلي)</button>
            </div>
          </div>
        </div>
      </div>

      <div class="row grid-2">
        <div class="card" style="border-style:dashed;">
          <div class="wrap">
            <div><span class="tag">شايب القلوب (King ♥)</span> <span class="muted small">−75 | الدبل −150 | مكافأة مُجبِر اختيارية عند الدبل</span></div>
            <div class="row grid-3">
              <div>
                <label>من أكل الملك؟</label>
                <select id="khWho"></select>
              </div>
              <div>
                <label class="nowrap">دبل؟</label>
                <select id="khDbl">
                  <option value="no">لا</option>
                  <option value="yes">نعم</option>
                </select>
              </div>
              <div>
                <label>من أجبره؟ (اختياري)</label>
                <select id="khForcer"></select>
              </div>
            </div>
            <div class="row grid-3">
              <div>
                <label>قيمة مكافأة المُجبِر (عند الدبل فقط)</label>
                <input id="khBonus" type="number" inputmode="numeric" value="25" />
              </div>
              <div class="buttons" style="align-items:end;">
                <button id="applyKing" class="primary">إضافة جولة ملك القلوب</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="border-style:dashed;">
          <div class="wrap">
            <div><span class="tag">لطوش (آخر لَطْشة)</span> <span class="muted small">من يأخذ آخر لطشة −25 • الدبل −50</span></div>
            <div class="row grid-3">
              <div>
                <label>من أخذ آخر لطشة؟</label>
                <select id="ltWho"></select>
              </div>
              <div>
                <label class="nowrap">دبل؟</label>
                <select id="ltDbl">
                  <option value="no">لا</option>
                  <option value="yes">نعم</option>
                </select>
              </div>
            </div>
            <div class="buttons">
              <button id="applyLotoush" class="primary">إضافة جولة اللطوش</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="border-style:dashed; margin-top:12px;">
        <div class="wrap">
          <div><span class="tag">ديناري (♦)</span> <span class="muted small">لكل ديناري −5 • مع الدبل −10</span></div>
          <div class="row grid-4">
            <div><label>ديناري لاعب 1</label><input id="d0" type="number" min="0" value="0"></div>
            <div><label>لاعب 2</label><input id="d1" type="number" min="0" value="0"></div>
            <div><label>لاعب 3</label><input id="d2" type="number" min="0" value="0"></div>
            <div><label>لاعب 4</label><input id="d3" type="number" min="0" value="0"></div>
          </div>
          <div class="buttons">
            <label><input id="ddbl" type="checkbox"> دبل</label>
            <button id="applyDenari" class="primary">إضافة جولة الديناري</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0;">📒 الجولات</h3>
      <div class="scroll-x">
        <table id="roundsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>الجولة</th>
              <th>ملاحظة</th>
              <th class="nowrap" id="h0">لاعب 1</th>
              <th class="nowrap" id="h1">لاعب 2</th>
              <th class="nowrap" id="h2">لاعب 3</th>
              <th class="nowrap" id="h3">لاعب 4</th>
              <th>الإجمالي</th>
            </tr>
          </thead>
          <tbody id="roundsBody"></tbody>
          <tfoot>
            <tr class="totals">
              <td colspan="3">المجموع</td>
              <td id="t0">0</td>
              <td id="t1">0</td>
              <td id="t2">0</td>
              <td id="t3">0</td>
              <td id="tAll">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </main>

  <div id="toast" class="toast">تمت إضافة الجولة ✅</div>

<script>
// Register SW
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js');
  });
}

(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const state = {
    players: ["لاعب 1","لاعب 2","لاعب 3","لاعب 4"],
    rounds: []
  };

  const KEYS = {
    players: "trix_pwa_v4_players",
    rounds: "trix_pwa_v4_rounds"
  };

  function saveLS(){
    try {
      localStorage.setItem(KEYS.players, JSON.stringify(state.players));
      localStorage.setItem(KEYS.rounds, JSON.stringify(state.rounds));
    } catch(e){}
  }
  function loadLS(){
    try {
      const p = JSON.parse(localStorage.getItem(KEYS.players));
      const r = JSON.parse(localStorage.getItem(KEYS.rounds));
      if (Array.isArray(p) && p.length === 4) state.players = p;
      if (Array.isArray(r)) state.rounds = r;
    } catch(e){}
  }

  function showToast(msg="تمت إضافة الجولة ✅"){
    const t = $("#toast");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(()=>{ t.style.display="none"; }, 1600);
  }

  function setSelectOptions(el, names, preserve=true){
    if (!el) return;
    const prev = preserve ? el.value : "";
    while (el.options.length) el.remove(0);
    el.add(new Option("—",""));
    names.forEach((n,idx)=> el.add(new Option(n, String(idx))));
    if (preserve && prev !== "" && Number(prev) >= 0) el.value = prev;
  }

  function refreshAllPlayerSelects(preserve=true){
    const names = state.players.map((n,i)=> n || ("لاعب "+(i+1)));
    ["qD_taker","qH_taker","qS_taker","qC_taker",
     "qD_forcer","qH_forcer","qS_forcer","qC_forcer",
     "khWho","khForcer","ltWho"].forEach(id=>{
      setSelectOptions($("#"+id), names, preserve);
    });
  }

  function renderPlayers(){
    for (let i=0;i<4;i++){
      $("#p"+i).value = state.players[i] || ("لاعب "+(i+1));
      $("#h"+i).textContent = state.players[i] || ("لاعب "+(i+1));
    }
    refreshAllPlayerSelects(true); // preserve current selections
  }

  function totals(){
    const t = [0,0,0,0];
    let all = 0;
    for (const r of state.rounds){
      for (let i=0;i<4;i++){ t[i] += (Number(r.scores[i])||0); }
      all += r.scores.reduce((a,b)=>a+(Number(b)||0),0);
    }
    for (let i=0;i<4;i++){ $("#t"+i).textContent = t[i]; }
    $("#tAll").textContent = all;
  }

  function renderRounds(){
    const body = $("#roundsBody");
    body.innerHTML = "";
    state.rounds.forEach((r,idx)=>{
      const tr = document.createElement("tr");
      const sum = r.scores.reduce((a,b)=>a+(Number(b)||0),0);
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${r.label || "-"}</td>
        <td>${r.note || "-"}</td>
        <td>${r.scores[0]}</td>
        <td>${r.scores[1]}</td>
        <td>${r.scores[2]}</td>
        <td>${r.scores[3]}</td>
        <td>${sum}</td>
      `;
      tr.classList.add("highlight");
      body.appendChild(tr);
    });
    totals();
    saveLS();
    const container = body.parentElement;
    container.scrollTop = container.scrollHeight;
  }

  function addRound(label, note, scores){
    try{
      const nums = scores.map(v => Number(v)||0);
      state.rounds.push({label, note, scores: nums});
      renderRounds();
      showToast();
    } catch(e){
      alert("تعذر إضافة الجولة. حدث خطأ غير متوقع.");
    }
  }

  function init(){
    loadLS();
    renderPlayers();
    renderRounds();

    $("#saveNamesBtn").addEventListener("click", ()=>{
      for (let i=0;i<4;i++){
        state.players[i] = $("#p"+i).value.trim() || ("لاعب "+(i+1));
      }
      renderPlayers(); // refresh with preserve
      saveLS();
      showToast("تم حفظ الأسماء ✅");
    });

    $("#refreshListsBtn").addEventListener("click", ()=>{
      refreshAllPlayerSelects(true);
      showToast("تم تحديث القوائم 🔁");
    });

    $("#resetAllBtn").addEventListener("click", ()=>{
      if (!confirm("هل تريد إعادة ضبط كل شيء؟ ستُحذف الجولات والأسماء.")) return;
      state.players = ["لاعب 1","لاعب 2","لاعب 3","لاعب 4"];
      state.rounds = [];
      renderPlayers();
      renderRounds();
      showToast("تمت إعادة الضبط ♻️");
    });

    $("#undoBtn").addEventListener("click", ()=>{
      if (state.rounds.length === 0) return;
      state.rounds.pop();
      renderRounds();
      showToast("تم التراجع ↩️");
    });

    $("#addRoundBtn").addEventListener("click", ()=>{
      const label = $("#roundLabel").value.trim();
      const note = $("#roundNote").value.trim();
      const s0 = $("#s0").value, s1=$("#s1").value, s2=$("#s2").value, s3=$("#s3").value;
      addRound(label || "إدخال يدوي", note, [s0,s1,s2,s3]);
      ["#roundLabel","#roundNote","#s0","#s1","#s2","#s3"].forEach(id=>$(id).value="");
    });

    // Queens detailed
    $("#applyQueensDetailed").addEventListener("click", ()=>{
      const scores = [0,0,0,0];
      const bonus = Number($("#qBonus").value)||0;

      const queens = [
        { taker: $("#qD_taker").value, dbl: $("#qD_dbl").value==="yes", forcer: $("#qD_forcer").value, name:"Q♦" },
        { taker: $("#qH_taker").value, dbl: $("#qH_dbl").value==="yes", forcer: $("#qH_forcer").value, name:"Q♥" },
        { taker: $("#qS_taker").value, dbl: $("#qS_dbl").value==="yes", forcer: $("#qS_forcer").value, name:"Q♠" },
        { taker: $("#qC_taker").value, dbl: $("#qC_dbl").value==="yes", forcer: $("#qC_forcer").value, name:"Q♣" },
      ];

      let noteParts = [];
      queens.forEach(q => {
        if (q.taker !== "") {
          const penalty = q.dbl ? -50 : -25;
          scores[Number(q.taker)] += penalty;
          noteParts.push(`${q.name}: لاعب ${Number(q.taker)+1}${q.dbl?"(دبل)":""}`);
          if (q.dbl && q.forcer !== "") {
            scores[Number(q.forcer)] += bonus;
            noteParts.push(`+${bonus} للمُجبِر (لاعب ${Number(q.forcer)+1})`);
          }
        }
      });

      if (noteParts.length === 0) { alert("أدخل على الأقل بنت واحدة."); return; }
      addRound("البنات (تفصيلي)", noteParts.join(" | "), scores);

      // reset fields for next entry
      ["qD_taker","qH_taker","qS_taker","qC_taker",
       "qD_forcer","qH_forcer","qS_forcer","qC_forcer"].forEach(id=>$("#"+id).value="");
      ["qD_dbl","qH_dbl","qS_dbl","qC_dbl"].forEach(id=>$("#"+id).value="no");
    });

    // King of Hearts
    $("#applyKing").addEventListener("click", ()=>{
      const who = $("#khWho").value;
      if (who===""){ alert("اختر اللاعب الذي أكل ملك القلوب."); return; }
      const dbl = $("#khDbl").value === "yes";
      const forcer = $("#khForcer").value;
      const bonus = Number($("#khBonus").value)||0;

      const scores = [0,0,0,0];
      scores[Number(who)] += dbl ? -150 : -75;
      let note = `لاعب ${Number(who)+1}` + (dbl?" (دبل)":"");

      if (dbl && forcer !== "") {
        scores[Number(forcer)] += bonus;
        note += ` | +${bonus} للمُجبِر (لاعب ${Number(forcer)+1})`;
      }

      addRound("ملك القلوب", note, scores);
      $("#khWho").value=""; $("#khDbl").value="no"; $("#khForcer").value="";
    });

    // Denari
    $("#applyDenari").addEventListener("click", ()=>{
      const d = [$("#d0").value, $("#d1").value, $("#d2").value, $("#d3").value].map(n=>Number(n)||0);
      const dbl = $("#ddbl").checked;
      const per = dbl ? -10 : -5;
      const scores = d.map(cnt => cnt * per);
      addRound("ديناري"+(dbl?" (دبل)":""), "", scores);
    });

    // Lotoush
    $("#applyLotoush").addEventListener("click", ()=>{
      const sel = $("#ltWho").value;
      if (sel===""){ alert("اختر اللاعب الذي أخذ آخر لطشة."); return; }
      const dbl = $("#ltDbl").value === "yes";
      const scores = [0,0,0,0];
      scores[Number(sel)] = dbl ? -50 : -25;
      addRound("لطوش"+(dbl?" (دبل)":"") , "", scores);
      $("#ltWho").value=""; $("#ltDbl").value="no";
    });

    // Export / Import
    $("#exportBtn").addEventListener("click", ()=>{
      const data = {
        players: state.players,
        rounds: state.rounds,
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "trix_scores.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    $("#importFile").addEventListener("change", (e)=>{
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(){
        try{
          const data = JSON.parse(reader.result);
          if (Array.isArray(data.players) && Array.isArray(data.rounds)){
            state.players = data.players.slice(0,4);
            state.rounds = data.rounds;
            renderPlayers();
            renderRounds();
            showToast("تم الاستيراد بنجاح ✅");
          } else {
            alert("ملف غير صالح.");
          }
        } catch(err){
          alert("تعذر قراءة الملف.");
        }
      };
      reader.readAsText(file);
      e.target.value = "";
    });

  } // init

  document.addEventListener("DOMContentLoaded", init);
})();
</script>
</body>
</html>
